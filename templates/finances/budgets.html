{% extends "base.html" %}

{% block content %}
<style>
  .budget-card {
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 1rem;
  }
  .progress-custom {
    height: 8px;
    border-radius: 10px;
  }
  .budget-status {
    font-size: 0.9rem;
    font-weight: 600;
  }
</style>

<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 text-primary fw-bold mb-1">
        <i class="bi bi-piggy-bank me-2"></i>Budget Management
      </h1>
      <p class="text-muted mb-0">Set spending limits and track your expenses</p>
    </div>
    <div>
      <a href="{{ url_for('add_budget') }}" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i>Add Budget
      </a>
    </div>
  </div>

  {% if budgets %}
    <div class="row">
      {% for budget in budgets %}
      <div class="col-md-6 col-lg-4 mb-3">
        <div class="budget-card">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h6 class="fw-bold mb-1">{{ budget.category }}</h6>
              <small class="text-muted">Monthly Budget</small>
            </div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="editBudget({{ budget.id }})" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="deleteBudget({{ budget.id }})" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <!-- Budget Progress -->
          {% set spent_percentage = (budget.current_month_spent / budget.monthly_limit * 100) if budget.monthly_limit > 0 else 0 %}
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="small text-muted">Spent</span>
              <span class="small text-muted">${{ "%.2f"|format(budget.current_month_spent) }} / ${{ "%.2f"|format(budget.monthly_limit) }}</span>
            </div>
            <div class="progress progress-custom">
              <div class="progress-bar 
                {{ 'bg-success' if spent_percentage < 50 else 'bg-warning' if spent_percentage < budget.alert_threshold else 'bg-danger' }}" 
                role="progressbar" 
                style="width: {{ spent_percentage }}%"
                aria-valuenow="{{ spent_percentage }}" 
                aria-valuemin="0" 
                aria-valuemax="100">
              </div>
            </div>
            <div class="budget-status mt-1 
              {{ 'text-success' if spent_percentage < 50 else 'text-warning' if spent_percentage < budget.alert_threshold else 'text-danger' }}">
              {{ "%.1f"|format(spent_percentage) }}% used
            </div>
          </div>

          <!-- Remaining Budget -->
          {% set remaining = budget.monthly_limit - budget.current_month_spent %}
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <small class="text-muted">Remaining</small>
              <div class="fw-bold {{ 'text-success' if remaining > 0 else 'text-danger' }}">
                ${{ "%.2f"|format(remaining) }}
              </div>
            </div>
            <div class="text-end">
              <small class="text-muted">Alert at {{ budget.alert_threshold }}%</small>
              {% if spent_percentage >= budget.alert_threshold %}
                <div class="badge bg-warning text-dark">
                  <i class="bi bi-exclamation-triangle me-1"></i>Over Threshold
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Budget Summary -->
    <div class="budget-card mt-4">
      <h5 class="text-primary mb-3">
        <i class="bi bi-graph-up me-2"></i>Budget Summary
      </h5>
      <div class="row">
        <div class="col-md-3 text-center">
          <div class="h4 text-primary">${{ "%.2f"|format(budgets|sum(attribute='monthly_limit')) }}</div>
          <small class="text-muted">Total Monthly Budget</small>
        </div>
        <div class="col-md-3 text-center">
          <div class="h4 text-warning">${{ "%.2f"|format(budgets|sum(attribute='current_month_spent')) }}</div>
          <small class="text-muted">Total Spent This Month</small>
        </div>
        <div class="col-md-3 text-center">
          <div class="h4 text-success">${{ "%.2f"|format(budgets|sum(attribute='monthly_limit') - budgets|sum(attribute='current_month_spent')) }}</div>
          <small class="text-muted">Total Remaining</small>
        </div>
        <div class="col-md-3 text-center">
          <div class="h4 text-info">{{ budgets|length }}</div>
          <small class="text-muted">Active Budgets</small>
        </div>
      </div>
    </div>

  {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
      <i class="bi bi-piggy-bank text-muted" style="font-size: 4rem;"></i>
      <h4 class="text-muted mt-3">No Budgets Set</h4>
      <p class="text-muted">Create budgets to track your spending and stay within limits.</p>
      <a href="{{ url_for('add_budget') }}" class="btn btn-success btn-lg">
        <i class="bi bi-plus-circle me-2"></i>Create Your First Budget
      </a>
    </div>
  {% endif %}

  <!-- Budget Tips -->
  <div class="budget-card mt-4 bg-light">
    <h5 class="text-primary mb-3">
      <i class="bi bi-lightbulb me-2"></i>Budget Tips
    </h5>
    <div class="row">
      <div class="col-md-6">
        <ul class="list-unstyled">
          <li><i class="bi bi-check-circle text-success me-2"></i>Set realistic monthly limits</li>
          <li><i class="bi bi-check-circle text-success me-2"></i>Monitor spending regularly</li>
          <li><i class="bi bi-check-circle text-success me-2"></i>Adjust budgets based on patterns</li>
        </ul>
      </div>
      <div class="col-md-6">
        <ul class="list-unstyled">
          <li><i class="bi bi-check-circle text-success me-2"></i>Use categories for better tracking</li>
          <li><i class="bi bi-check-circle text-success me-2"></i>Set alert thresholds (recommended: 80%)</li>
          <li><i class="bi bi-check-circle text-success me-2"></i>Review and update monthly</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
function editBudget(id) {
  window.location.href = `/finances/budget/${id}/edit`;
}

function deleteBudget(id) {
  if (confirm('Are you sure you want to delete this budget? This action cannot be undone.')) {
    // Create a form to submit the DELETE request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/finances/budget/${id}/delete`;
    
    // Add CSRF token if available
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (csrfToken) {
      const tokenInput = document.createElement('input');
      tokenInput.type = 'hidden';
      tokenInput.name = 'csrf_token';
      tokenInput.value = csrfToken.getAttribute('content');
      form.appendChild(tokenInput);
    }
    
    document.body.appendChild(form);
    form.submit();
  }
}

function toggleBudget(id) {
  if (confirm('Are you sure you want to change the status of this budget?')) {
    // Create a form to submit the toggle request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/finances/budget/${id}/toggle`;
    
    // Add CSRF token if available
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (csrfToken) {
      const tokenInput = document.createElement('input');
      tokenInput.type = 'hidden';
      tokenInput.name = 'csrf_token';
      tokenInput.value = csrfToken.getAttribute('content');
      form.appendChild(tokenInput);
    }
    
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
{% endblock %}