{% extends "base.html" %}
{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
<style>
  body {
    background: #f4f6fb;
  }
  .dashboard-card {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    transition: box-shadow 0.3s;
    margin-bottom: 30px;
  }
  .dashboard-card:hover {
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  }
  .dashboard-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
  }
  .dashboard-header h2 {
    margin: 0;
    font-weight: 700;
    color: #2d3748;
  }
  .dashboard-avatar {
    width: 60px;
    height: 60px;
    background: #e2e8f0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: #4a5568;
    font-weight: bold;
  }
  .dashboard-label {
    color: #718096;
    font-weight: 500;
  }
  .dashboard-value {
    color: #2d3748;
    font-weight: 600;
  }
  .visit {
    background: #f9fafc;
    border: none;
    border-left: 5px solid #3182ce;
    border-radius: 12px;
    transition: box-shadow 0.3s;
    box-shadow: 0 2px 8px rgba(49,130,206,0.06);
  }
  .visit:hover {
    box-shadow: 0 4px 16px rgba(49,130,206,0.12);
    border-left: 5px solid #2b6cb0;
  }
  .btn {
    border-radius: 8px;
    font-weight: 600;
    letter-spacing: 0.5px;
    transition: transform 0.2s;
  }
  .btn:hover {
    transform: translateY(-2px) scale(1.03);
  }
  .img-xray {
    border-radius: 10px;
    border: 2px solid #e2e8f0;
    margin-top: 10px;
    box-shadow: 0 2px 8px rgba(49,130,206,0.08);
    transition: box-shadow 0.3s;
  }
  .img-xray:hover {
    box-shadow: 0 6px 24px rgba(49,130,206,0.18);
  }
  /* Missing Appointments specific styling */
  .missing-appointment-card {
    background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    border-left: 4px solid #f56565 !important;
  }
  
  .missing-appointment-card:hover {
    background: linear-gradient(135deg, #fff1f1 0%, #feb2b2 100%);
    transform: translateY(-2px);
  }
  
  .overdue-badge {
    background: linear-gradient(135deg, #f56565, #e53e3e);
    color: white;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  /* Uniform thumbnail sizing */
  .xray-thumb {
    width: 120px;
    height: 90px;
    object-fit: cover;
    margin: 5px;
    cursor: pointer;
  }
  /* Lightbox modal */
  .lightbox-modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(2px);
  }
  .lightbox-content {
    position: relative;
    max-width: 80%;
    max-height: 80%;
    margin: 60px auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #lightboxImage {
    max-width: 100%;
    max-height: 80vh;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }
  .lightbox-close {
    position: absolute;
    top: -40px;
    right: 0;
    font-size: 32px;
    color: #fff;
    cursor: pointer;
  }
  .nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
    border: none;
    font-size: 40px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background .25s;
  }
  .nav-btn:hover {
    background: rgba(255, 255, 255, 0.35);
  }
  .nav-prev {
    left: 15px;
  }
  .nav-next {
    right: 15px;
  }
  .thumb-counter {
    position: absolute;
    bottom: -38px;
    left: 50%;
    transform: translateX(-50%);
    color: #fff;
    font-weight: 600;
    letter-spacing: 1px;
  }
</style>

<div class="container mt-5 animate__animated animate__fadeIn">
  <div class="dashboard-header">
    <div class="dashboard-avatar animate__animated animate__zoomIn">
      <i class="fas fa-user"></i>
    </div>
    <h2>Patient Dashboard</h2>
  </div>

  <div class="dashboard-card card animate__animated animate__fadeInUp">
    <div class="card-body">
      <h4 class="card-title mb-3">{{ patient.name }} <span class="badge bg-primary ms-2">ID: {{ patient.doctor_patient_id or patient.id }}</span></h4>
      <div class="row mb-2">
        <div class="col-md-4 mb-2">
          <span class="dashboard-label">Phone:</span>
          <div class="dashboard-value">{{ patient.phone }}</div>
        </div>
        <div class="col-md-4 mb-2">
          <span class="dashboard-label">Age:</span>
          <div class="dashboard-value">{{ patient.age }}</div>
        </div>
        <div class="col-md-4 mb-2">
          <span class="dashboard-label">Diagnosis:</span>
          <div class="dashboard-value">{{ patient.diagnosis }}</div>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col-md-4 mb-2">
          <span class="dashboard-label">First Visit:</span>
          <div class="dashboard-value">{{ patient.first_visit.strftime('%Y-%m-%d %I:%M %p') if patient.first_visit else 'N/A' }}</div>
        </div>
        <div class="col-md-4 mb-2">
          <span class="dashboard-label">Next Visit:</span>
          <div class="dashboard-value">{{ patient.next_visit.strftime('%Y-%m-%d %I:%M %p') if patient.next_visit else 'N/A' }}</div>
        </div>
        <div class="col-md-4 mb-2">
          <span class="dashboard-label">Completed:</span>
          <div class="dashboard-value">{{ 'Yes' if patient.completed else 'No' }}</div>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col-md-4 mb-2">
          <span class="dashboard-label">Amount Due:</span>
          <div class="dashboard-value">{{ patient.amount_due + (visits|map(attribute='amount_due')|sum) }} L.E</div>
        </div>
        <div class="col-md-4 mb-2">
          <span class="dashboard-label">Amount Paid:</span>
          <div class="dashboard-value">{{ patient.amount_paid + (visits|map(attribute='amount_paid')|sum) }} L.E</div>
        </div>
        <div class="col-md-4 mb-2">
          <span class="dashboard-label">Total Remaining:</span>
          <div class="dashboard-value text-danger">{{ (patient.amount_due + (visits|map(attribute='amount_due')|sum)) - (patient.amount_paid + (visits|map(attribute='amount_paid')|sum)) }} L.E</div>
        </div>
      </div>

      <a href="{{ url_for('edit_patient', patient_id=patient.id) }}" class="btn btn-warning mt-4"><i class="fas fa-edit"></i> Edit Patient Info</a>
    </div>
  </div>

  <div class="dashboard-header mt-5">
    <i class="fas fa-history fa-lg text-primary"></i>
    <h3 class="mb-0">Visit History</h3>
    <div class="ms-auto d-flex gap-2">
      <button class="btn btn-success" onclick="openAppointmentModal({{ patient.id }}, '{{ patient.name }}')">
        <i class="fas fa-calendar-plus"></i> New Appointment
      </button>
      <a href="{{ url_for('add_visit', patient_id=patient.id) }}" class="btn btn-primary animate__animated animate__pulse animate__infinite">+ Add Visit</a>
    </div>
  </div>

  {% if visits %}
    <div class="row">
      {% for visit in visits|sort(attribute='visit_date', reverse=True) %}
        <div class="col-md-6 animate__animated animate__fadeInUp mb-4">
          <div class="visit p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span><strong>Date:</strong> {{ visit.visit_date.strftime('%A %m/%d/%Y at %I:%M %p') }}</span>
              <span class="badge bg-info text-dark">{{ visit.diagnosis or 'N/A' }}</span>
            </div>
            <p class="mb-1"><strong>Medications:</strong> {{ visit.medications or 'None' }}</p>
            <div class="row mb-2">
              <div class="col-4">
                <span class="dashboard-label">Due:</span>
                <div class="dashboard-value">{{ visit.amount_due }} L.E</div>
              </div>
              <div class="col-4">
                <span class="dashboard-label">Paid:</span>
                <div class="dashboard-value">{{ visit.amount_paid }} L.E</div>
              </div>
              <div class="col-4">
                <span class="dashboard-label">Remaining:</span>
                <div class="dashboard-value text-danger">{{ (visit.amount_due or 0) - (visit.amount_paid or 0) }} L.E</div>
              </div>
            </div>
            {% if visit.xray_filenames %}
              <div class="mt-2 xray-group" data-images="{{ visit.xray_filenames }}">
                <span class="dashboard-label">Images:</span><br>
                {% for filename in visit.xray_filenames.split(',') %}
                  <img src="{{ url_for('static', filename='xrays/' + filename) }}" class="img-xray xray-thumb animate__animated animate__fadeIn" data-index="{{ loop.index0 }}" alt="Image {{ loop.index }} for visit {{ visit.id }}" title="Click to enlarge" data-edit-url="{{ url_for('edit_visit', visit_id=visit.id) }}">
                {% endfor %}
                <div><a href="{{ url_for('edit_visit', visit_id=visit.id) }}" class="btn btn-sm btn-outline-primary mt-2">Edit Visit</a></div>
              </div>
            {% else %}
              <p class="text-muted"><strong>Images:</strong> No image uploaded <a href="{{ url_for('edit_visit', visit_id=visit.id) }}" class="btn btn-sm btn-outline-primary ms-2">Edit Visit</a></p>
            {% endif %}
            <form method="POST" action="{{ url_for('delete_visit', visit_id=visit.id) }}">
              <button type="submit" class="btn btn-sm btn-danger mt-3" onclick="return confirm('Delete this visit?');"><i class="fas fa-trash"></i> Delete Visit</button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No visits recorded yet.</p>
  {% endif %}
</div>

<!-- Upcoming Appointments Section -->
<div class="dashboard-header mt-5">
  <i class="fas fa-calendar-check fa-lg text-success"></i>
  <h3 class="mb-0">Upcoming Appointments</h3>
  <span class="badge bg-success ms-2">{{ appointments|length }}</span>
</div>

{% if appointments %}
  <div class="row">
    {% for appointment in appointments %}
      <div class="col-md-6 animate__animated animate__fadeInUp mb-4">
        <div class="dashboard-card p-4 border-start border-success border-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h5 class="text-success mb-1">
                <i class="fas fa-{{ 'user-md' if appointment.appointment_type == 'consultation' else 'stethoscope' if appointment.appointment_type == 'checkup' else 'pills' if appointment.appointment_type == 'treatment' else 'cut' if appointment.appointment_type == 'surgery' else 'clipboard-check' if appointment.appointment_type == 'follow-up' else 'exclamation-triangle' }} me-2"></i>
                {{ (appointment.appointment_type or 'Unknown').title() }}
              </h5>
              <p class="text-muted mb-2">
                <i class="fas fa-calendar text-primary me-1"></i>
                {{ appointment.appointment_date.strftime('%A, %B %d, %Y') }}
              </p>
              <p class="text-muted mb-2">
                <i class="fas fa-clock text-warning me-1"></i>
                {{ appointment.appointment_date.strftime('%I:%M %p') }} 
                <span class="badge bg-light text-dark ms-1">{{ appointment.duration }}min</span>
              </p>
            </div>
            <div class="text-end">
              <span class="badge bg-{{ 'danger' if appointment.priority == 'urgent' else 'warning' if appointment.priority == 'high' else 'info' if appointment.priority == 'medium' else 'secondary' }}">
                {{ (appointment.priority or 'Medium').title() }}
              </span>
            </div>
          </div>
          
          {% if appointment.notes %}
            <div class="mb-3">
              <strong class="text-muted">Notes:</strong>
              <p class="mb-0">{{ appointment.notes }}</p>
            </div>
          {% endif %}
          
          <div class="d-flex gap-2 flex-wrap">
            <!-- <button class="btn btn-sm btn-outline-primary edit-appointment-btn" 
                    data-id="{{ appointment.id }}" 
                    data-date="{{ appointment.appointment_date.isoformat() }}" 
                    data-type="{{ appointment.appointment_type or 'consultation' }}" 
                    data-notes="{{ appointment.notes or '' }}" 
                    data-duration="{{ appointment.duration or 60 }}" 
                    data-priority="{{ appointment.priority or 'medium' }}">
              <i class="fas fa-edit me-1"></i>Edit
            </button> -->
            <button class="btn btn-sm btn-outline-danger" onclick="deleteAppointment({{ appointment.id }})">
              <i class="fas fa-trash me-1"></i>Delete
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="markAppointmentCompleted({{ appointment.id }})">
              <i class="fas fa-check me-1"></i>Mark Completed
            </button>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="text-center py-5">
    <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
    <p class="text-muted">No upcoming appointments scheduled.</p>
    <button class="btn btn-success" onclick="openAppointmentModal({{ patient.id }}, '{{ patient.name }}')">
      <i class="fas fa-plus me-1"></i>Schedule First Appointment
    </button>
  </div>
{% endif %}

<!-- Missing Appointments Section -->
<div class="dashboard-header mt-5">
  <i class="fas fa-calendar-times fa-lg text-danger"></i>
  <h3 class="mb-0">Missing Appointments</h3>
  <span class="badge bg-danger ms-2">{{ missed_appointments|length }}</span>
</div>

{% if missed_appointments %}
  <div class="row">
    {% for appointment in missed_appointments %}
      <div class="col-md-6 animate__animated animate__fadeInUp mb-4">
        <div class="dashboard-card missing-appointment-card p-4 border-start border-danger border-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h5 class="text-danger mb-1">
                <i class="fas fa-{{ 'user-md' if appointment.appointment_type == 'consultation' else 'stethoscope' if appointment.appointment_type == 'checkup' else 'pills' if appointment.appointment_type == 'treatment' else 'cut' if appointment.appointment_type == 'surgery' else 'clipboard-check' if appointment.appointment_type == 'follow-up' else 'exclamation-triangle' }} me-2"></i>
                {{ (appointment.appointment_type or 'Unknown').title() }}
              </h5>
              <p class="text-muted mb-2">
                <i class="fas fa-calendar text-primary me-1"></i>
                {{ appointment.appointment_date.strftime('%A, %B %d, %Y') }}
              </p>
              <p class="text-muted mb-2">
                <i class="fas fa-clock text-warning me-1"></i>
                {{ appointment.appointment_date.strftime('%I:%M %p') }} 
                <span class="badge bg-light text-dark ms-1">{{ appointment.duration }}min</span>
              </p>
              <p class="text-danger mb-2">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>Status:</strong> {{ appointment.status.title() if appointment.status else 'Missed' }}
                <small class="text-muted">(Overdue)</small>
              </p>
            </div>
            <div class="text-end">
              <span class="badge bg-{{ 'danger' if appointment.priority == 'urgent' else 'warning' if appointment.priority == 'high' else 'info' if appointment.priority == 'medium' else 'secondary' }}">
                {{ (appointment.priority or 'Medium').title() }}
              </span>
            </div>
          </div>
          
          {% if appointment.notes %}
            <div class="mb-3">
              <strong class="text-muted">Notes:</strong>
              <p class="mb-0">{{ appointment.notes }}</p>
            </div>
          {% endif %}
          
          <div class="d-flex gap-2 flex-wrap">
            <!-- <button class="btn btn-sm btn-outline-success reschedule-appointment-btn" 
                    data-id="{{ appointment.id }}" 
                    data-type="{{ appointment.appointment_type or 'consultation' }}" 
                    data-notes="{{ appointment.notes or '' }}" 
                    data-duration="{{ appointment.duration or 60 }}" 
                    data-priority="{{ appointment.priority or 'medium' }}">
              <i class="fas fa-calendar-plus me-1"></i>Reschedule
            </button> -->
            <button class="btn btn-sm btn-outline-warning" onclick="markAppointmentCompleted({{ appointment.id }})">
              <i class="fas fa-check me-1"></i>Mark Completed
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteAppointment({{ appointment.id }})">
              <i class="fas fa-trash me-1"></i>Delete
            </button>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="text-center py-4">
    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
    <p class="text-muted">No missing appointments. Great job keeping up with the schedule!</p>
  </div>
{% endif %}

<!-- Lightbox Modal -->
<div id="xrayModal" class="lightbox-modal" role="dialog" aria-modal="true" aria-label="Image viewer">
  <div class="lightbox-content">
    <span class="lightbox-close" id="lightboxClose" aria-label="Close viewer">&times;</span>
    <button class="nav-btn nav-prev" id="lightboxPrev" aria-label="Previous image">&#10094;</button>
    <img id="lightboxImage" src="" alt="Enlarged image">
    <button class="nav-btn nav-next" id="lightboxNext" aria-label="Next image">&#10095;</button>
    <div class="thumb-counter" id="lightboxCounter"></div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('xrayModal');
  const imgEl = document.getElementById('lightboxImage');
  const closeBtn = document.getElementById('lightboxClose');
  const prevBtn = document.getElementById('lightboxPrev');
  const nextBtn = document.getElementById('lightboxNext');
  const counterEl = document.getElementById('lightboxCounter');
  let images = []; // array of URLs
  let current = 0;

  function show(index){
    if(!images.length) return;
    current = (index + images.length) % images.length;
    imgEl.src = images[current];
    counterEl.textContent = (current+1) + ' / ' + images.length;
  }
  function open(list, startIndex){
    images = list;
    show(startIndex || 0);
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
  function close(){
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
  document.querySelectorAll('.xray-group').forEach(group => {
    const raw = group.getAttribute('data-images') || '';
    const list = raw.split(',').map(s => s.trim()).filter(Boolean).map(f => `${window.location.origin}${"{{ url_for('static', filename='xrays/') }}"}${f}`);
    group.querySelectorAll('img.xray-thumb').forEach(thumb => {
      thumb.addEventListener('click', (ev) => {
        if (ev.shiftKey) { // Shift+Click to go to edit page
          const editUrl = thumb.getAttribute('data-edit-url');
          if(editUrl) window.location = editUrl;
          return;
        }
        const idx = parseInt(thumb.getAttribute('data-index'), 10) || 0;
        open(list, idx);
      });
    });
  });
  closeBtn.addEventListener('click', close);
  modal.addEventListener('click', e => { if(e.target === modal) close(); });
  prevBtn.addEventListener('click', () => show(current - 1));
  nextBtn.addEventListener('click', () => show(current + 1));
  document.addEventListener('keydown', e => {
    if(modal.style.display !== 'block') return;
    if(e.key === 'Escape') close();
    if(e.key === 'ArrowLeft') show(current - 1);
    if(e.key === 'ArrowRight') show(current + 1);
  });
})();

// Appointment Modal Functions
function getDefaultAppointmentDate() {
  // Get current date/time in Egypt timezone (UTC+2)
  const now = new Date();
  // Calculate Egypt offset in minutes
  const egyptOffset = 2 * 60;
  // Get UTC time
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  // Egypt time
  const egyptDate = new Date(utc + (egyptOffset * 60000));

  // Add 7 days for next week, same hour/minute as click
  egyptDate.setDate(egyptDate.getDate() + 7);

  // Format for datetime-local input (YYYY-MM-DDTHH:MM)
  const pad = n => n.toString().padStart(2, '0');
  const yyyy = egyptDate.getFullYear();
  const mm = pad(egyptDate.getMonth() + 1);
  const dd = pad(egyptDate.getDate());
  const hh = pad(egyptDate.getHours());
  const min = pad(egyptDate.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
}

function openAppointmentModal(patientId, patientName) {
    document.getElementById('appointmentPatientId').value = patientId;
    document.getElementById('appointmentPatientName').textContent = patientName;
    
    // Set default date to next week on a weekday at 9:00 AM
    document.getElementById('appointmentDate').value = getDefaultAppointmentDate();
    
    // Set minimum date to current date/time to prevent past appointments
    const now = new Date();
    const minDateStr = now.toISOString().slice(0, 16);
    document.getElementById('appointmentDate').min = minDateStr;
    
    const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
    modal.show();
}

function submitAppointment() {
    const form = document.getElementById('appointmentForm');
    const formData = new FormData(form);
    
    const appointmentData = {
        patient_id: parseInt(formData.get('patient_id')),
        appointment_date: formData.get('appointment_date'),
        appointment_type: formData.get('appointment_type'),
        notes: formData.get('notes'),
        duration: parseInt(formData.get('duration')),
        priority: formData.get('priority')
    };
    
    fetch('/api/appointments', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(appointmentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Appointment created successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
            modal.hide();
            location.reload(); // Refresh to show the appointment
        } else {
            alert('Error creating appointment: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the appointment');
    });
}

// Edit appointment function
function editAppointment(id, date, type, notes, duration, priority) {
    // Populate the form with existing data
    document.getElementById('appointmentPatientId').value = {{ patient.id }};
    document.getElementById('appointmentPatientName').textContent = '{{ patient.name }}';
    document.getElementById('appointmentDate').value = date.slice(0, 16); // Format for datetime-local
    document.getElementById('appointmentType').value = type;
    document.getElementById('appointmentNotes').value = notes;
    document.getElementById('appointmentDuration').value = duration;
    document.getElementById('appointmentPriority').value = priority;
    
    // Change the submit button to update mode
    const submitBtn = document.querySelector('#appointmentModal .btn-success');
    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Update Appointment';
    submitBtn.onclick = () => updateAppointment(id);
    
    // Change modal title
    document.querySelector('#appointmentModal .modal-title').innerHTML = 
        '<i class="fas fa-edit text-warning me-2"></i>Edit Appointment for {{ patient.name }}';
    
    const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
    modal.show();
}

// Update appointment function
function updateAppointment(appointmentId) {
    const form = document.getElementById('appointmentForm');
    const formData = new FormData(form);
    
    const appointmentData = {
        appointment_date: formData.get('appointment_date'),
        appointment_type: formData.get('appointment_type'),
        notes: formData.get('notes'),
        duration: parseInt(formData.get('duration')),
        priority: formData.get('priority')
    };
    
    fetch(`/api/appointments/${appointmentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(appointmentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Appointment updated successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error updating appointment: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the appointment');
    });
}

// Delete appointment function
function deleteAppointment(appointmentId) {
    if (!confirm('Are you sure you want to delete this appointment?')) {
        return;
    }
    
    fetch(`/api/appointments/${appointmentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Appointment deleted successfully!');
            location.reload();
        } else {
            alert('Error deleting appointment: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the appointment');
    });
}

// Mark appointment as completed
function markAppointmentCompleted(appointmentId) {
    if (!confirm('Mark this appointment as completed?')) {
        return;
    }
    
    fetch(`/api/appointments/${appointmentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({status: 'completed'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Appointment marked as completed!');
            location.reload();
        } else {
            alert('Error updating appointment: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the appointment');
    });
}

// Reschedule appointment function
function rescheduleAppointment(appointmentId, appointmentType, notes, duration, priority) {
    console.log('Reschedule clicked for appointment:', appointmentId);
    
    // Store the appointment ID for later use
    window.currentRescheduleId = appointmentId;
    
    // Reset and show the modal
    document.getElementById('appointmentForm').reset();
    
    // Set modal title to indicate rescheduling
    document.querySelector('#appointmentModal .modal-title').innerHTML = 
        '<i class="fas fa-calendar-plus text-warning me-2"></i>Reschedule Appointment';
    
    // Pre-fill the form with existing data
    setTimeout(() => {
        document.getElementById('appointmentType').value = appointmentType;
        document.getElementById('appointmentNotes').value = notes;
        document.getElementById('appointmentDuration').value = duration;
        document.getElementById('appointmentPriority').value = priority;
        
        // Set patient ID for the modal
        document.getElementById('appointmentPatientId').value = {{ patient.id }};
        
        // Set minimum date to current date/time to prevent past appointments
        const now = new Date();
        const isoString = now.toISOString().slice(0, 16);
        document.getElementById('appointmentDate').min = isoString;
        document.getElementById('appointmentDate').value = '';
        
        // Update the submit button to handle rescheduling
        const submitBtn = document.querySelector('#appointmentModal .btn-success');
        submitBtn.innerHTML = '<i class="fas fa-calendar-check me-1"></i>Reschedule Appointment';
        submitBtn.setAttribute('onclick', 'rescheduleAppointmentSubmit()');
    }, 100);
    
    // Show the modal using Bootstrap's modal method
    $('#appointmentModal').modal('show');
}

// Submit rescheduled appointment
function rescheduleAppointmentSubmit() {
    const appointmentId = window.currentRescheduleId;
    console.log('Submitting reschedule for appointment:', appointmentId);
    
    if (!appointmentId) {
        alert('Error: No appointment selected for rescheduling');
        return;
    }
    
    const appointmentDate = document.getElementById('appointmentDate').value;
    const appointmentType = document.getElementById('appointmentType').value;
    const appointmentNotes = document.getElementById('appointmentNotes').value;
    const appointmentDuration = document.getElementById('appointmentDuration').value;
    const appointmentPriority = document.getElementById('appointmentPriority').value;
    
    console.log('Form data:', { appointmentDate, appointmentType, appointmentNotes, appointmentDuration, appointmentPriority });
    
    if (!appointmentDate) {
        alert('Please select a new appointment date and time');
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('#appointmentModal .btn-success');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Rescheduling...';
    submitBtn.disabled = true;
    
    // Update the existing appointment with new date/time
    fetch(`/api/appointments/${appointmentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            appointment_date: appointmentDate,
            appointment_type: appointmentType,
            notes: appointmentNotes,
            duration: parseInt(appointmentDuration),
            priority: appointmentPriority,
            status: 'scheduled'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Appointment rescheduled successfully!');
            $('#appointmentModal').modal('hide');
            location.reload();
        } else {
            alert('Error rescheduling appointment: ' + (data.error || 'Unknown error'));
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while rescheduling the appointment');
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Reset appointment modal to create mode
document.getElementById('appointmentModal').addEventListener('hidden.bs.modal', function() {
    // Clear reschedule state
    window.currentRescheduleId = null;
    
    // Reset submit button
    const submitBtn = document.querySelector('#appointmentModal .btn-success');
    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Create Appointment';
    submitBtn.setAttribute('onclick', 'submitAppointment()');
    submitBtn.disabled = false;
    
    // Reset modal title
    document.querySelector('#appointmentModal .modal-title').innerHTML = 
        '<i class="fas fa-calendar-plus text-success me-2"></i>New Appointment for <span id="appointmentPatientName"></span>';
    
    // Clear form
    document.getElementById('appointmentForm').reset();
    
    // Set default date to next week on a weekday at 9:00 AM after reset
    document.getElementById('appointmentDate').value = getDefaultAppointmentDate();
    
    // Set minimum date to current date/time to prevent past appointments
    const now = new Date();
    const minDateStr = now.toISOString().slice(0, 16);
    document.getElementById('appointmentDate').min = minDateStr;
    
    // Add event listeners for edit appointment buttons with data attributes
    document.querySelectorAll('.edit-appointment-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const date = this.dataset.date;
            const type = this.dataset.type || 'consultation';
            const notes = this.dataset.notes || '';
            const duration = this.dataset.duration || 60;
            const priority = this.dataset.priority || 'medium';
            
            editAppointment(id, date, type, notes, duration, priority);
        });
    });
    
    // Add event listeners for reschedule appointment buttons
    document.querySelectorAll('.reschedule-appointment-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const type = this.dataset.type || 'consultation';
            const notes = this.dataset.notes || '';
            const duration = this.dataset.duration || 60;
            const priority = this.dataset.priority || 'medium';
            
            rescheduleAppointment(id, type, notes, duration, priority);
        });
    });
});
</script>

<!-- Appointment Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus text-success me-2"></i>
                    New Appointment for <span id="appointmentPatientName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="appointmentForm">
                <div class="modal-body">
                    <input type="hidden" id="appointmentPatientId" name="patient_id">
                    
                    <div class="mb-3">
                        <label for="appointmentDate" class="form-label">
                            <i class="fas fa-calendar text-primary me-1"></i>Date & Time
                        </label>
                        <input type="datetime-local" class="form-control" id="appointmentDate" name="appointment_date" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle text-primary me-1"></i>
                            Default is set to next week at 9:00 AM on a weekday
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="appointmentType" class="form-label">
                            <i class="fas fa-stethoscope text-info me-1"></i>Appointment Type
                        </label>
                        <select class="form-control" id="appointmentType" name="appointment_type" required>
                            <option value="">Select type...</option>
                            <option value="consultation">Consultation</option>
                            <option value="checkup">Checkup</option>
                            <option value="treatment">Treatment</option>
                            <option value="surgery">Surgery</option>
                            <option value="follow-up">Follow-up</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="appointmentDuration" class="form-label">
                            <i class="fas fa-clock text-warning me-1"></i>Duration (minutes)
                        </label>
                        <select class="form-control" id="appointmentDuration" name="duration">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">1 hour</option>
                            <option value="90">1.5 hours</option>
                            <option value="120">2 hours</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="appointmentPriority" class="form-label">
                            <i class="fas fa-exclamation-triangle text-danger me-1"></i>Priority
                        </label>
                        <select class="form-control" id="appointmentPriority" name="priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="appointmentNotes" class="form-label">
                            <i class="fas fa-notes-medical text-secondary me-1"></i>Notes
                        </label>
                        <textarea class="form-control" id="appointmentNotes" name="notes" rows="3" placeholder="Additional notes or symptoms..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="submitAppointment()">
                        <i class="fas fa-save me-1"></i>Create Appointment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</script>

<!-- FontAwesome for icons -->
<script src="https://kit.fontawesome.com/7c8e6e4b6a.js" crossorigin="anonymous"></script>
{% endblock %}
