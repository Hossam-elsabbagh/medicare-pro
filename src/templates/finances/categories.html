{% extends "base.html" %}

{% block content %}
<style>
  .category-card {
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: transform 0.3s;
  }
  .category-card:hover {
    transform: translateY(-2px);
  }
  .color-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
  }
</style>

<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 text-primary fw-bold mb-1">
        <i class="bi bi-tags me-2"></i>Financial Categories
      </h1>
      <p class="text-muted mb-0">Organize your income and expenses with custom categories</p>
    </div>
    <div>
      <a href="{{ url_for('add_expense_category') }}" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i>Add Category
      </a>
    </div>
  </div>

  <!-- Income Categories Section -->
  {% if income_categories %}
  <div class="mb-4">
    <h4 class="text-success mb-3">
      <i class="bi bi-arrow-up-circle me-2"></i>Income Categories
    </h4>
    <div class="row">
      {% for category in income_categories %}
      <div class="col-md-4 col-lg-3 mb-3">
        <div class="category-card">
          <div class="d-flex align-items-center mb-2">
            <span class="color-indicator" style="background-color: {{ category.color }};"></span>
            <h6 class="mb-0 fw-bold">{{ category.name }}</h6>
            <div class="ms-auto">
              <span class="badge bg-success">Income</span>
              {% if category.is_default %}
                <span class="badge bg-info ms-1">Default</span>
              {% endif %}
            </div>
          </div>
          {% if category.description %}
          <p class="text-muted small mb-2">{{ category.description }}</p>
          {% endif %}
          
          <div class="d-flex justify-content-between align-items-center">
            <span class="badge {{ 'bg-success' if category.is_active else 'bg-secondary' }}">
              {{ 'Active' if category.is_active else 'Inactive' }}
            </span>
            
            <div class="btn-group btn-group-sm">
              {% if category.is_default %}
                <button class="btn btn-outline-primary" onclick="convertDefaultCategory('{{ category.name }}', 'income')" title="Convert to Custom">
                  <i class="bi bi-pencil"></i>
                </button>
              {% else %}
                <button class="btn btn-outline-primary" onclick="editCategory({{ category.id }})" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-warning" onclick="toggleCategory({{ category.id }})" title="{{ 'Deactivate' if category.is_active else 'Activate' }}">
                  <i class="bi bi-{{ 'eye-slash' if category.is_active else 'eye' }}"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteCategory({{ category.id }})" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              {% endif %}
            </div>
          </div>
          
          <small class="text-muted">Created: {{ category.created_at.strftime('%b %d, %Y') }}</small>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Expense Categories Section -->
  {% if expense_categories %}
  <div class="mb-4">
    <h4 class="text-danger mb-3">
      <i class="bi bi-arrow-down-circle me-2"></i>Expense Categories
    </h4>
    <div class="row">
      {% for category in expense_categories %}
      <div class="col-md-4 col-lg-3 mb-3">
        <div class="category-card">
          <div class="d-flex align-items-center mb-2">
            <span class="color-indicator" style="background-color: {{ category.color }};"></span>
            <h6 class="mb-0 fw-bold">{{ category.name }}</h6>
            <div class="ms-auto">
              <span class="badge bg-danger">Expense</span>
              {% if category.is_default %}
                <span class="badge bg-info ms-1">Default</span>
              {% endif %}
            </div>
          </div>
          
          {% if category.description %}
            <p class="text-muted small mb-3">{{ category.description }}</p>
          {% endif %}
          
          <div class="d-flex justify-content-between align-items-center">
            <span class="badge {{ 'bg-success' if category.is_active else 'bg-secondary' }}">
              {{ 'Active' if category.is_active else 'Inactive' }}
            </span>
            
            <div class="btn-group btn-group-sm">
              {% if category.is_default %}
                <button class="btn btn-outline-primary" onclick="convertDefaultCategory('{{ category.name }}', 'expense')" title="Convert to Custom">
                  <i class="bi bi-pencil"></i>
                </button>
              {% else %}
                <button class="btn btn-outline-primary" onclick="editCategory({{ category.id }})" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-warning" onclick="toggleCategory({{ category.id }})" title="{{ 'Deactivate' if category.is_active else 'Activate' }}">
                  <i class="bi bi-{{ 'eye-slash' if category.is_active else 'eye' }}"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteCategory({{ category.id }})" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              {% endif %}
            </div>
          </div>
          
          <small class="text-muted">Created: {{ category.created_at.strftime('%b %d, %Y') }}</small>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
      <i class="bi bi-tags text-muted" style="font-size: 4rem;"></i>
      <h4 class="text-muted mt-3">No Categories Yet</h4>
      <p class="text-muted">Create categories to better organize your transactions.</p>
      <a href="{{ url_for('add_expense_category') }}" class="btn btn-success btn-lg">
        <i class="bi bi-plus-circle me-2"></i>Create Your First Category
      </a>
    </div>
  {% endif %}

  <!-- Category Management Tips -->
  <div class="mt-5">
    <div class="category-card bg-light">
      <h5 class="text-primary mb-3">
        <i class="bi bi-lightbulb me-2"></i>Category Management Tips
      </h5>
      <div class="row">
        <div class="col-md-6">
          <ul class="list-unstyled">
            <li><i class="bi bi-check-circle text-success me-2"></i>Use meaningful category names</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Assign distinct colors for easy identification</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Separate income and expense categories</li>
          </ul>
        </div>
        <div class="col-md-6">
          <ul class="list-unstyled">
            <li><i class="bi bi-check-circle text-success me-2"></i>Default categories can be converted to custom for editing</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Deactivate unused categories instead of deleting</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Review and organize categories regularly</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function editCategory(id) {
  window.location.href = `/finances/category/${id}/edit`;
}

function deleteCategory(id) {
  if (confirm('Are you sure you want to delete this category? This will also remove it from any existing transactions and budgets.')) {
    // Create a form to submit the DELETE request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/finances/category/${id}/delete`;
    
    // Add CSRF token if available
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (csrfToken) {
      const tokenInput = document.createElement('input');
      tokenInput.type = 'hidden';
      tokenInput.name = 'csrf_token';
      tokenInput.value = csrfToken.getAttribute('content');
      form.appendChild(tokenInput);
    }
    
    document.body.appendChild(form);
    form.submit();
  }
}

function toggleCategory(id) {
  if (confirm('Are you sure you want to change the status of this category?')) {
    // Create a form to submit the toggle request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/finances/category/${id}/toggle`;
    
    // Add CSRF token if available
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (csrfToken) {
      const tokenInput = document.createElement('input');
      tokenInput.type = 'hidden';
      tokenInput.name = 'csrf_token';
      tokenInput.value = csrfToken.getAttribute('content');
      form.appendChild(tokenInput);
    }
    
    document.body.appendChild(form);
    form.submit();
  }
}

function convertDefaultCategory(categoryName, categoryType) {
  if (confirm(`Convert "${categoryName}" to a custom category for editing?`)) {
    // Create a form to submit the convert request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/finances/category/default/${categoryName}/convert`;
    
    // Add category type
    const typeInput = document.createElement('input');
    typeInput.type = 'hidden';
    typeInput.name = 'type';
    typeInput.value = categoryType;
    form.appendChild(typeInput);
    
    // Add CSRF token if available
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (csrfToken) {
      const tokenInput = document.createElement('input');
      tokenInput.type = 'hidden';
      tokenInput.name = 'csrf_token';
      tokenInput.value = csrfToken.getAttribute('content');
      form.appendChild(tokenInput);
    }
    
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
{% endblock %}