{% extends "base.html" %}

{% block content %}
<style>
  .transactions-card {
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    padding: 1.5rem;
  }
  .transaction-row:hover {
    background-color: #f8fafc;
    transform: translateX(2px);
    transition: all 0.2s;
  }
  .filter-card {
    background: #f8fafc;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }
</style>

<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 text-primary fw-bold mb-1">
        <i class="bi bi-list-ul me-2"></i>Financial Transactions
      </h1>
      <p class="text-muted mb-0">View and manage all transactions</p>
    </div>
    <div>
      <a href="{{ url_for('add_financial_transaction') }}" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i>Add Transaction
      </a>
      <a href="{{ url_for('financial_reports') }}" class="btn btn-primary ms-2">
        <i class="bi bi-file-earmark-bar-graph me-1"></i>Generate Report
      </a>
    </div>
  </div>

  <!-- Quick Filters -->
  <div class="filter-card">
    <form method="GET" action="{{ url_for('financial_transactions') }}">
      <div class="row align-items-center">
        <div class="col-md-2">
          <select class="form-select" name="type">
            <option value="">All Types</option>
            <option value="income" {% if filters.type == 'income' %}selected{% endif %}>Income Only</option>
            <option value="expense" {% if filters.type == 'expense' %}selected{% endif %}>Expenses Only</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="category">
            <option value="">All Categories</option>
            {% for category in categories %}
            <option value="{{ category }}" {% if filters.category == category %}selected{% endif %}>
              {{ category }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <input type="date" class="form-control" name="start_date" value="{{ filters.start_date }}" placeholder="Start date">
        </div>
        <div class="col-md-2">
          <input type="date" class="form-control" name="end_date" value="{{ filters.end_date }}" placeholder="End date">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-outline-primary w-100">
            <i class="bi bi-funnel me-1"></i>Apply Filters
          </button>
        </div>
        <div class="col-md-1">
          <a href="{{ url_for('financial_transactions') }}" class="btn btn-outline-secondary w-100" title="Clear Filters">
            <i class="bi bi-x-circle"></i>
          </a>
        </div>
      </div>
    </form>
  </div>

  <!-- Filter Results Summary (only show if filters are applied) -->
  {% if filter_applied and filtered_totals %}
  <div class="card mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <div class="card-body">
      <h5 class="card-title mb-3">
        <i class="bi bi-funnel-fill me-2"></i>Filter Results
      </h5>
      <div class="row">
        <div class="col-md-3 text-center">
          <div class="h4 text-success">${{ "%.2f"|format(filtered_totals.income) }}</div>
          <small>Total Income</small>
        </div>
        <div class="col-md-3 text-center">
          <div class="h4 text-danger">${{ "%.2f"|format(filtered_totals.expenses) }}</div>
          <small>Total Expenses</small>
        </div>
        <div class="col-md-3 text-center">
          <div class="h4 {% if filtered_totals.profit >= 0 %}text-success{% else %}text-danger{% endif %}">
            ${{ "%.2f"|format(filtered_totals.profit) }}
          </div>
          <small>Net Profit</small>
        </div>
        <div class="col-md-3 text-center">
          <div class="h4">{{ filtered_totals.count }}</div>
          <small>Transactions</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Active Filters Display -->
  {% if filter_applied %}
  <div class="mb-3">
    <h6>Active Filters:</h6>
    {% if filters.type %}
    <span class="badge bg-primary me-2">Type: {{ filters.type.title() }}</span>
    {% endif %}
    {% if filters.category %}
    <span class="badge bg-primary me-2">Category: {{ filters.category }}</span>
    {% endif %}
    {% if filters.start_date %}
    <span class="badge bg-primary me-2">From: {{ filters.start_date }}</span>
    {% endif %}
    {% if filters.end_date %}
    <span class="badge bg-primary me-2">To: {{ filters.end_date }}</span>
    {% endif %}
    {% if filters.min_amount %}
    <span class="badge bg-primary me-2">Min: ${{ filters.min_amount }}</span>
    {% endif %}
    {% if filters.max_amount %}
    <span class="badge bg-primary me-2">Max: ${{ filters.max_amount }}</span>
    {% endif %}
  </div>
  {% endif %}

  <!-- Transactions Table -->
  <div class="transactions-card">
    {% if transactions.items %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Date & Time</th>
              <th>Type</th>
              <th>Category</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Payment Method</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in transactions.items %}
            <tr class="transaction-row">
              <td>
                <div class="fw-semibold">{{ transaction.transaction_date.strftime('%b %d, %Y') }}</div>
                <small class="text-muted">{{ transaction.transaction_date.strftime('%I:%M %p') }}</small>
              </td>
              <td>
                <span class="badge {{ 'bg-success' if transaction.transaction_type == 'income' else 'bg-danger' }} px-3 py-2">
                  <i class="bi bi-{{ 'arrow-up' if transaction.transaction_type == 'income' else 'arrow-down' }} me-1"></i>
                  {{ transaction.transaction_type.title() }}
                </span>
              </td>
              <td>
                <span class="fw-semibold">{{ transaction.category }}</span>
                {% if transaction.subcategory %}
                  <br><small class="text-muted">{{ transaction.subcategory }}</small>
                {% endif %}
              </td>
              <td>
                <div class="fw-semibold">{{ transaction.description[:60] }}{% if transaction.description|length > 60 %}...{% endif %}</div>
                {% if transaction.notes %}
                  <small class="text-muted">{{ transaction.notes[:40] }}{% if transaction.notes|length > 40 %}...{% endif %}</small>
                {% endif %}
              </td>
              <td>
                <span class="fw-bold {{ 'text-success' if transaction.transaction_type == 'income' else 'text-danger' }}" style="font-size: 1.1rem;">
                  {{ '+' if transaction.transaction_type == 'income' else '-' }}${{ "%.2f"|format(transaction.amount) }}
                </span>
              </td>
              <td>
                {% if transaction.payment_method %}
                  <span class="badge bg-light text-dark">
                    <i class="bi bi-{{ 'cash' if transaction.payment_method == 'cash' else 'credit-card' if transaction.payment_method == 'card' else 'bank' if transaction.payment_method == 'bank_transfer' else 'clipboard-check' }} me-1"></i>
                    {{ transaction.payment_method.replace('_', ' ').title() }}
                  </span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('view_financial_transaction', transaction_id=transaction.id) }}" 
                     class="btn btn-outline-primary" title="View Details">
                    <i class="bi bi-eye"></i>
                  </a>
                  <a href="{{ url_for('edit_financial_transaction', transaction_id=transaction.id) }}" 
                     class="btn btn-outline-warning" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <button class="btn btn-outline-danger" 
                          onclick="confirmDelete({{ transaction.id }}, '{{ transaction.category }}', {{ transaction.amount }})" 
                          title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if transactions.pages > 1 %}
        <nav aria-label="Transactions pagination" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if transactions.has_prev %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('financial_transactions', page=transactions.prev_num, **request.args) }}">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
            {% endif %}
            
            {% for page_num in transactions.iter_pages() %}
              {% if page_num %}
                {% if page_num != transactions.page %}
                  <li class="page-item">
                    <a class="page-link" href="{{ url_for('financial_transactions', page=page_num, **request.args) }}">{{ page_num }}</a>
                  </li>
                {% else %}
                  <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                  </li>
                {% endif %}
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              {% endif %}
            {% endfor %}
            
            {% if transactions.has_next %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('financial_transactions', page=transactions.next_num, **request.args) }}">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}

    {% else %}
      <!-- Empty State -->
      <div class="text-center py-5">
        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
        <h4 class="text-muted mt-3">No Transactions Found</h4>
        <p class="text-muted">Start by adding your first financial transaction.</p>
        <a href="{{ url_for('add_financial_transaction') }}" class="btn btn-success btn-lg mt-3">
          <i class="bi bi-plus-circle me-2"></i>Add Your First Transaction
        </a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Transaction Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="transactionDetails">
        <!-- Transaction details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this transaction?</p>
        <div class="alert alert-info" id="deleteInfo">
          <!-- Transaction info will be inserted here -->
        </div>
        <p class="text-danger"><strong>This action cannot be undone.</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" id="deleteForm" style="display: inline;">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash me-2"></i>Delete Transaction
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function confirmDelete(id, category, amount) {
  const deleteInfo = document.getElementById('deleteInfo');
  const deleteForm = document.getElementById('deleteForm');
  
  deleteInfo.innerHTML = `
    <strong>Category:</strong> ${category}<br>
    <strong>Amount:</strong> $${parseFloat(amount).toFixed(2)}
  `;
  
  deleteForm.action = `/finances/transaction/${id}/delete`;
  
  const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
  deleteModal.show();
}
</script>
{% endblock %}